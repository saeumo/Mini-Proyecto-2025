---
title: "Importación_prueba"
output: html_document
date: "2025-04-11"
---

```{r}
library(pdftools)
library(stringr)

df_productos <- data.frame(Factura = character(0), 
                           Cantidad = numeric(0), 
                           Peso = numeric(0),
                           Producto = character(0), 
                           Precio_Unitario = numeric(0),
                           Precio_Total = numeric(0),
                           stringsAsFactors = FALSE)

df_ticket <- data.frame(Factura = character(0), 
                        Direccion = character(0), 
                        Fecha = character(0), 
                        Importe = numeric(0), 
                        Num_Productos = integer(0), 
                        Parking = logical(0), 
                        Metodo_Pago = factor(character(0), levels = c("Efectivo", "Tarjeta")), 
                        stringsAsFactors = FALSE)

lista_filas_ticket <- list()
lista_filas_producto <- list()

ruta_txt <- "data_txt"
archivos <- list.files(path = ruta_txt, full.names = TRUE)

for (i in 1:length(archivos)) {
  if (grepl("Mercadona", archivos[i])) {
    contenido <- readLines(archivos[i], warn = FALSE)
    
    inicio_productos <- grep("PRODUCTOS|DESCRIPCIÓN", contenido, ignore.case = TRUE)
    fin_total <- grep("TOTAL", contenido, ignore.case = TRUE)

    encabezado <- contenido[1:(inicio_productos - 1)]
    productos <- contenido[inicio_productos:(fin_total - 1)]
    parte_final <- contenido[fin_total:length(contenido)]

    factura <- regmatches(encabezado[6], regexpr("\\d{4}-\\d{3}-\\d+", encabezado[6]))
    direccion <- encabezado[2]
    fecha <- regmatches(encabezado[5], regexpr("\\d{2}/\\d{2}/\\d{4}", encabezado[5]))
    
    importe <- as.numeric(gsub(",", ".", regmatches(parte_final[1], regexpr("\\d+,\\d{2}", parte_final[1]))))
    
    metodo_pago <- if (any(grepl("TARJETA", parte_final, ignore.case = TRUE))) {
      "Tarjeta"
    } else if (any(grepl("EFECTIVO", parte_final, ignore.case = TRUE))) {
      "Efectivo"
    } else {
      NA
    }
    
    productos_limpios <- productos[-1]
    productos_limpios <- trimws(productos_limpios)
    productos_limpios <- productos_limpios[productos_limpios != ""]

    tiene_parking <- ifelse(any(grepl("PARKING", productos_limpios, ignore.case = TRUE)), TRUE, FALSE)

    df_lineas <- data.frame(linea = productos_limpios, stringsAsFactors = FALSE)

    productos_extraidos <- data.frame(Factura = character(), 
                                      Cantidad = numeric(), 
                                      Peso = numeric(),
                                      Producto = character(), 
                                      Precio_Unitario = numeric(),
                                      Precio_Total = numeric(), 
                                      stringsAsFactors = FALSE)

    for (j in 1:nrow(df_lineas)) {
      linea <- df_lineas$linea[j]

      # Si es una línea de producto con peso (formato "COL LOMBARDA 0,840 kg    1,85 €/kg")
      if (grepl("\\d+,\\d+\\s*kg", linea, ignore.case = TRUE)) {
        nombre <- trimws(gsub("(\\d+,\\d+\\s*kg.*)", "", linea))
        peso <- as.numeric(gsub(",", ".", str_extract(linea, "\\d+,\\d+\\s*kg")))
        precio_unit <- as.numeric(gsub(",", ".", str_extract(linea, "\\d+,\\d+\\s*€/kg")))
        precio_total <- round(precio_unit * peso, 2)

        productos_extraidos <- rbind(productos_extraidos, data.frame(
          Factura = factura,
          Cantidad = 1,
          Peso = peso,
          Producto = nombre,
          Precio_Unitario = precio_unit,
          Precio_Total = precio_total,
          stringsAsFactors = FALSE
        ))

      } else if (grepl("^\\d+\\s", linea)) {
        # Línea con cantidad explícita ("2 TOMATE TRITURADO 0,75")
        cantidad <- as.numeric(str_extract(linea, "^\\d+"))
        precio <- as.numeric(gsub(",", ".", str_extract(linea, "\\d+,\\d{2}$")))
        nombre <- trimws(gsub("^\\d+\\s+|\\s+\\d+,\\d{2}$", "", linea))

        productos_extraidos <- rbind(productos_extraidos, data.frame(
          Factura = factura,
          Cantidad = cantidad,
          Peso = NA,
          Producto = nombre,
          Precio_Unitario = precio,
          Precio_Total = round(cantidad * precio, 2),
          stringsAsFactors = FALSE
        ))

      } else {
        # Posible caso especial: línea sin cantidad o continuación de otro producto
        nombre <- trimws(gsub("\\s+\\d+,\\d{2}$", "", linea))
        precio <- as.numeric(gsub(",", ".", str_extract(linea, "\\d+,\\d{2}$")))
        
        productos_extraidos <- rbind(productos_extraidos, data.frame(
          Factura = factura,
          Cantidad = 1,
          Peso = NA,
          Producto = nombre,
          Precio_Unitario = precio,
          Precio_Total = precio,
          stringsAsFactors = FALSE
        ))
      }
    }

    df_ticket <- data.frame(Factura = factura,
                            Direccion = direccion,
                            Fecha = fecha,
                            Importe = importe,
                            Num_Productos = nrow(productos_extraidos),
                            Parking = tiene_parking,
                            Metodo_Pago = metodo_pago,
                            stringsAsFactors = FALSE)

    lista_filas_ticket[[i]] <- df_ticket
    lista_filas_producto[[i]] <- productos_extraidos
  }
}

df_tickets <- do.call(rbind, lista_filas_ticket)
df_productos <- do.call(rbind, lista_filas_producto)

```
